----------- BOARD ------------

root@salvator-x:~# mount -t tmpfs -o size=400M tmpfs /tmp
root@salvator-x:~# 
root@salvator-x:~# dd if=/dev/zero of=/tmp/tmp.img bs=1M count=350
350+0 records in
350+0 records out
367001600 bytes (367 MB, 350 MiB) copied, 1.75596 s, 209 MB/s
root@salvator-x:~# 
root@salvator-x:~# mkfs.ext3 -L storage /tmp/tmp.img
mke2fs 1.47.0 (5-Feb-2023)
Discarding device blocks:      0/358400             done                            
Creating filesystem with 358400 1k blocks and 89760 inodes
Filesystem UUID: 49cf1f5b-df58-4d82-9ff1-2af390c893a6
Superblock backups stored on blocks: 
	8193, 24577, 40961, 57345, 73729, 204801, 221185

Allocating group tables:  0/44     done                            
Writing inode tables:  0/44     done                            
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information:  0/44     done

root@salvator-x:~# 
root@salvator-x:~# modprobe g_mass_storage file=/tmp/tmp.img
[  282.123217] Mass Storage Function, version: 2009/09/11
[  282.130299] LUN: removable file: (no medium)
[  282.136873] LUN: file: /tmp/tmp.img
[  282.140994] Number of LUNs=1
[  282.144888] g_mass_storage gadget: Mass Storage Gadget, version: 2009/09/11
[  282.152477] g_mass_storage gadget: userspace failed to provide iSerialNumber
[  282.160202] g_mass_storage gadget: g_mass_storage ready
root@salvator-x:~# 
root@salvator-x:~# cat /sys/devices/platform/soc/ee020000.usb/udc/ee020000.usb/s tate
configured
root@salvator-x:~# 
root@salvator-x:~# echo scan  > /sys/kernel/debug/kmemleak
root@salvator-x:~# 
root@salvator-x:~# echo clear > /sys/kernel/debug/kmemleak
root@salvator-x:~# 
---------- HOST-PC -----------

dmesg
[709705.761080] usb 2-2: new SuperSpeed USB device number 55 using xhci_hcd
[709705.781600] usb 2-2: New USB device found, idVendor=0525, idProduct=a4a5, bcdDevice= 5.10
[709705.781618] usb 2-2: New USB device strings: Mfr=3, Product=4, SerialNumber=0
[709705.781626] usb 2-2: Product: Mass Storage Gadget
[709705.781632] usb 2-2: Manufacturer: Linux 5.10.218-yocto-standard with renesas_usb3
[709705.785142] usb-storage 2-2:1.0: USB Mass Storage device detected
[709705.785960] usb-storage 2-2:1.0: Quirks match for vid 0525 pid a4a5: 10000
[709705.786087] scsi host3: usb-storage 2-2:1.0
[709706.809998] scsi 3:0:0:0: Direct-Access     Linux    File-Stor Gadget 0510 PQ: 0 ANSI: 2
[709706.810804] sd 3:0:0:0: Attached scsi generic sg1 type 0
[709706.811324] sd 3:0:0:0: Power-on or device reset occurred
[709706.811927] sd 3:0:0:0: [sdd] 716800 512-byte logical blocks: (367 MB/350 MiB)
[709706.812367] sd 3:0:0:0: [sdd] Write Protect is off
[709706.812382] sd 3:0:0:0: [sdd] Mode Sense: 0f 00 00 00
[709706.812770] sd 3:0:0:0: [sdd] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA
[709706.817277] sd 3:0:0:0: [sdd] Attached SCSI disk
[709707.135884] EXT4-fs (sdd): mounting ext3 file system using the ext4 subsystem
[709707.142391] EXT4-fs (sdd): mounted filesystem with ordered data mode. Opts: (null). Quota mode: none.

df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            3,8G     0  3,8G   0% /dev
tmpfs           784M  2,4M  781M   1% /run
/dev/nvme0n1p4  458G  296G  139G  69% /
tmpfs           3,9G     0  3,9G   0% /dev/shm
tmpfs           5,0M  4,0K  5,0M   1% /run/lock
tmpfs           3,9G     0  3,9G   0% /sys/fs/cgroup
/dev/loop0      128K  128K     0 100% /snap/bare/5
/dev/loop1       64M   64M     0 100% /snap/core20/2318
/dev/loop2      497M  497M     0 100% /snap/gnome-42-2204/141
/dev/loop3       56M   56M     0 100% /snap/core18/2829
/dev/loop4       13M   13M     0 100% /snap/snap-store/959
/dev/loop5       64M   64M     0 100% /snap/core20/2182
/dev/loop7      506M  506M     0 100% /snap/gnome-42-2204/176
/dev/loop17      75M   75M     0 100% /snap/core22/1439
/dev/loop10     384K  384K     0 100% /snap/device-tree-compiler/91
/dev/loop14     347M  347M     0 100% /snap/gnome-3-38-2004/119
/dev/loop8       13M   13M     0 100% /snap/snap-store/1113
/dev/loop13      41M   41M     0 100% /snap/snapd/20290
/dev/loop6       12M   12M     0 100% /snap/nmap/3470
/dev/loop9       75M   75M     0 100% /snap/core22/1380
/dev/loop16      92M   92M     0 100% /snap/gtk-common-themes/1535
/dev/loop15     350M  350M     0 100% /snap/gnome-3-38-2004/143
/dev/loop18     9,8M  9,8M     0 100% /snap/htop/4407
/dev/loop11      12M   12M     0 100% /snap/nmap/3514
/dev/loop12      39M   39M     0 100% /snap/snapd/21759
/dev/nvme0n1p1  3,7G  210M  3,3G   6% /boot
/dev/nvme0n1p2  3,9G  6,1M  3,9G   1% /boot/efi
tmpfs           784M   32K  784M   1% /run/user/1000
/dev/sdc1       944M  309M  588M  35% /mnt/usb
/dev/sdd        318M   47K  301M   1% /media/rvc/storage

dd if=/dev/urandom of=./file-10M bs=1M count=10
10+0 records in
10+0 records out
10485760 bytes (10 MB, 10 MiB) copied, 0,0460382 s, 228 MB/s

sudo cp ./file-10M_from_host /media/rvc/storage

md5sum ./file-10M /media/rvc/storage/file-10M
ddb98dc69f3a2ad0dbdd9a9488b5b5d4  ./file-10M
ddb98dc69f3a2ad0dbdd9a9488b5b5d4  /media/rvc/storage/file-10M

sudo umount /media/rvc/storage

----------- BOARD ------------

root@salvator-x:~# rmmod g_mass_storage
root@salvator-x:~# 
root@salvator-x:~# rm -rf /tmp/tmp.img
root@salvator-x:~# 

---------- HOST-PC -----------

dmesg
[709718.041660] usb 2-2: USB disconnect, device number 55
[709718.080776] sd 3:0:0:0: [sdd] Synchronizing SCSI cache
[709718.080830] sd 3:0:0:0: [sdd] Synchronize Cache(10) failed: Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK
BOARD
echo scan  > /sys/kernel/debug/kmemleak

root@salvator-x:~# echo scan > /sys/kernel/debug/kmemleak
[  300.160736] kmemleak: 4 new suspected memory leaks (see /sys/kernel/debug/kmemleak)
root@salvator-x:~# 
root@salvator-x:~# cat /sys/kernel/debug/kmemleak
unreferenced object 0xffff0005cc222700 (size 216):
  comm "kworker/3:1", pid 56, jiffies 4294950296 (age 69.120s)
  hex dump (first 32 bytes):
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00 e0 44 cc 05 00 ff ff 00 00 00 00 00 00 00 00  ..D.............
  backtrace:
    [<000000009220f29e>] kmem_cache_alloc_node+0x194/0x440
    [<00000000ccab95f3>] __alloc_skb+0x6c/0x19c
    [<000000008759893d>] ncm_wrap_ntb+0x214/0x380
    [<000000000645e182>] eth_start_xmit+0xe4/0x39c
    [<00000000e84735e8>] dev_hard_start_xmit+0x120/0x330
    [<00000000dfd3bec0>] sch_direct_xmit+0x94/0x35c
    [<00000000d46bc68e>] __qdisc_run+0x16c/0x724
    [<00000000269b5030>] __dev_queue_xmit+0xa94/0xfa0
    [<0000000095c50b04>] dev_queue_xmit+0x1c/0x30
    [<00000000cf8132b9>] neigh_resolve_output+0x104/0x1b0
    [<00000000b3a5dcb8>] ip6_finish_output2+0x248/0xc70 [ipv6]
    [<00000000d0561790>] __ip6_finish_output+0x170/0x340 [ipv6]
    [<000000007cc76e37>] ip6_output+0x84/0x37c [ipv6]
    [<000000007ab1d273>] ndisc_send_skb+0x328/0x874 [ipv6]
    [<000000005cdce386>] ndisc_send_ns+0xcc/0x210 [ipv6]
    [<00000000880a291a>] addrconf_dad_work+0x3e4/0x4d4 [ipv6]
unreferenced object 0xffff0005cc4e0000 (size 16704):
  comm "kworker/3:1", pid 56, jiffies 4294950296 (age 69.120s)
  hex dump (first 32 bytes):
    4e 43 4d 48 0c 00 00 00 00 00 00 00 33 33 ff 42  NCMH........33.B
    e2 e3 be 80 4e 42 e2 e3 86 dd 60 00 00 00 00 20  ....NB....`.... 
  backtrace:
    [<0000000047d84604>] kmalloc_large_node+0x11c/0x190
    [<0000000048ac08aa>] __kmalloc_node_track_caller+0x338/0x37c
    [<0000000068229d7c>] __kmalloc_reserve.isra.0+0x78/0xf4
    [<00000000c915691f>] __alloc_skb+0x94/0x19c
    [<000000008759893d>] ncm_wrap_ntb+0x214/0x380
    [<000000000645e182>] eth_start_xmit+0xe4/0x39c
    [<00000000e84735e8>] dev_hard_start_xmit+0x120/0x330
    [<00000000dfd3bec0>] sch_direct_xmit+0x94/0x35c
    [<00000000d46bc68e>] __qdisc_run+0x16c/0x724
    [<00000000269b5030>] __dev_queue_xmit+0xa94/0xfa0
    [<0000000095c50b04>] dev_queue_xmit+0x1c/0x30
    [<00000000cf8132b9>] neigh_resolve_output+0x104/0x1b0
    [<00000000b3a5dcb8>] ip6_finish_output2+0x248/0xc70 [ipv6]
    [<00000000d0561790>] __ip6_finish_output+0x170/0x340 [ipv6]
    [<000000007cc76e37>] ip6_output+0x84/0x37c [ipv6]
    [<000000007ab1d273>] ndisc_send_skb+0x328/0x874 [ipv6]
unreferenced object 0xffff0005cc222600 (size 216):
  comm "kworker/3:1", pid 56, jiffies 4294950296 (age 69.124s)
  hex dump (first 32 bytes):
    00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    00 e0 44 cc 05 00 ff ff 00 00 00 00 00 00 00 00  ..D.............
  backtrace:
    [<000000009220f29e>] kmem_cache_alloc_node+0x194/0x440
    [<00000000ccab95f3>] __alloc_skb+0x6c/0x19c
    [<00000000478ecdc6>] ncm_wrap_ntb+0x270/0x380
    [<000000000645e182>] eth_start_xmit+0xe4/0x39c
    [<00000000e84735e8>] dev_hard_start_xmit+0x120/0x330
    [<00000000dfd3bec0>] sch_direct_xmit+0x94/0x35c
    [<00000000d46bc68e>] __qdisc_run+0x16c/0x724
    [<00000000269b5030>] __dev_queue_xmit+0xa94/0xfa0
    [<0000000095c50b04>] dev_queue_xmit+0x1c/0x30
    [<00000000cf8132b9>] neigh_resolve_output+0x104/0x1b0
    [<00000000b3a5dcb8>] ip6_finish_output2+0x248/0xc70 [ipv6]
    [<00000000d0561790>] __ip6_finish_output+0x170/0x340 [ipv6]
    [<000000007cc76e37>] ip6_output+0x84/0x37c [ipv6]
    [<000000007ab1d273>] ndisc_send_skb+0x328/0x874 [ipv6]
    [<000000005cdce386>] ndisc_send_ns+0xcc/0x210 [ipv6]
    [<00000000880a291a>] addrconf_dad_work+0x3e4/0x4d4 [ipv6]
root@salvator-x:~# 
 
#### Result: OK ####
