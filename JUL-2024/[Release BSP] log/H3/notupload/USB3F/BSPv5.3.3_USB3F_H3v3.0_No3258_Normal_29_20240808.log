
root@salvator-x:~# zcat /proc/config.gz |grep DEBUG_LIST
CONFIG_DEBUG_LIST=y
root@salvator-x:~# 
root@salvator-x:~# insmod renesas_usb3.ko
[  396.929699] renesas_usb3 ee020000.usb: probed with phy
root@salvator-x:~# 
root@salvator-x:~# lsmod
Module                  Size  Used by
renesas_usb3           36864  0
crct10dif_ce           20480  1
ccree                 159744  0
dw_hdmi_cec            16384  0
gpio_bd9571mwv         16384  0
max9611                16384  0
at24                   24576  0
authenc                16384  1 ccree
libdes                 24576  1 ccree
optee_rng              16384  0
rng_core               24576  1 optee_rng
pwm_bl                 16384  0
cfg80211              872448  0
rfkill                 36864  2 cfg80211
uio_pdrv_genirq        16384  0
fuse                  143360  1
ipv6                  577536  24
root@salvator-x:~# 
root@salvator-x:~# modprobe g_printer
[  398.679673] printer gadget: printer ready
root@salvator-x:~# 
root@salvator-x:~# modprobe g_audio
[  399.155672] g_audio gadget: Linux USB Audio Gadget, version: Feb 2, 2012
[  399.162913] g_audio gadget: g_audio ready
root@salvator-x:~# ----------- BOARD ------------

root@salvator-x:~# mount -t tmpfs -o size=400M tmpfs /tmp
root@salvator-x:~# 
root@salvator-x:~# dd if=/dev/zero of=/tmp/tmp.img bs=1M count=350
350+0 records in
350+0 records out
367001600 bytes (367 MB, 350 MiB) copied, 1.70931 s, 215 MB/s
root@salvator-x:~# 
root@salvator-x:~# mkfs.ext3 -L storage /tmp/tmp.img
mke2fs 1.47.0 (5-Feb-2023)
Discarding device blocks:      0/358400             done                            
Creating filesystem with 358400 1k blocks and 89760 inodes
Filesystem UUID: 0338e3e2-1dc9-4d48-aa4e-d8cbc0a564cd
Superblock backups stored on blocks: 
	8193, 24577, 40961, 57345, 73729, 204801, 221185

Allocating group tables:  0/44     done                            
Writing inode tables:  0/44     done                            
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information:  0/44     done

root@salvator-x:~# 
root@salvator-x:~# modprobe g_mass_storage file=/tmp/tmp.img
[  404.685381] Mass Storage Function, version: 2009/09/11
[  404.690940] LUN: removable file: (no medium)
[  404.695909] LUN: file: /tmp/tmp.img
[  404.699548] Number of LUNs=1
[  404.703647] g_mass_storage gadget: Mass Storage Gadget, version: 2009/09/11
[  404.710759] g_mass_storage gadget: userspace failed to provide iSerialNumber
[  404.717919] g_mass_storage gadget: g_mass_storage ready
root@salvator-x:~# 
root@salvator-x:~# cat /sys/devices/platform/soc/ee020000.usb/udc/ee020000.usb/state
not attached
root@salvator-x:~# 
root@salvator-x:~# mount -t debugfs none /sys/kernel/debug/
mount: /sys/kernel/debug: none already mounted or mount point busy.
       dmesg(1) may have more information after failed mount system call.
root@salvator-x:~# 
root@salvator-x:~# echo 1 > /sys/kernel/debug/usb/ee020000.usb/b_device
root@salvator-x:~# 
root@salvator-x:~# cat /sys/devices/platform/soc/ee020000.usb/udc/ee020000.usb/state
configured
root@salvator-x:~# 
root@salvator-x:~# echo scan  > /sys/kernel/debug/kmemleak
root@salvator-x:~# 
root@salvator-x:~# echo clear > /sys/kernel/debug/kmemleak
root@salvator-x:~# 
---------- HOST-PC -----------

dmesg
[79220.475581] usb 2-1.4: new SuperSpeed USB device number 103 using xhci_hcd
[79220.497326] usb 2-1.4: New USB device found, idVendor=0525, idProduct=a4a5, bcdDevice= 5.10
[79220.497334] usb 2-1.4: New USB device strings: Mfr=3, Product=4, SerialNumber=0
[79220.497338] usb 2-1.4: Product: Mass Storage Gadget
[79220.497341] usb 2-1.4: Manufacturer: Linux 5.10.218-yocto-standard with renesas_usb3
[79220.500825] usb-storage 2-1.4:1.0: USB Mass Storage device detected
[79220.501133] usb-storage 2-1.4:1.0: Quirks match for vid 0525 pid a4a5: 10000
[79220.501242] scsi host1: usb-storage 2-1.4:1.0
[79221.520716] scsi 1:0:0:0: Direct-Access     Linux    File-Stor Gadget 0510 PQ: 0 ANSI: 2
[79221.521119] sd 1:0:0:0: Attached scsi generic sg1 type 0
[79221.521676] sd 1:0:0:0: Power-on or device reset occurred
[79221.522582] sd 1:0:0:0: [sdb] 716800 512-byte logical blocks: (367 MB/350 MiB)
[79221.630056] sd 1:0:0:0: [sdb] Write Protect is off
[79221.630063] sd 1:0:0:0: [sdb] Mode Sense: 0f 00 00 00
[79221.738264] sd 1:0:0:0: [sdb] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA
[79222.170144] sd 1:0:0:0: [sdb] Attached SCSI disk

df -h
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
loop0         7:0    0     4K  1 loop /snap/bare/5
loop1         7:1    0    64M  1 loop /snap/core20/2318
loop2         7:2    0  63,9M  1 loop /snap/core20/2182
loop3         7:3    0   292K  1 loop /snap/device-tree-compiler/91
loop4         7:4    0 505,1M  1 loop /snap/gnome-42-2204/176
loop5         7:5    0  74,2M  1 loop /snap/core22/1439
loop6         7:6    0  11,9M  1 loop /snap/nmap/3470
loop7         7:7    0 349,7M  1 loop /snap/gnome-3-38-2004/143
loop8         7:8    0  74,2M  1 loop /snap/core22/1380
loop9         7:9    0  12,9M  1 loop /snap/snap-store/1113
loop10        7:10   0  38,8M  1 loop /snap/snapd/21759
loop11        7:11   0  40,9M  1 loop /snap/snapd/20290
loop12        7:12   0  11,9M  1 loop /snap/nmap/3514
loop13        7:13   0  12,3M  1 loop /snap/snap-store/959
loop14        7:14   0   9,7M  1 loop /snap/htop/4407
loop15        7:15   0  91,7M  1 loop /snap/gtk-common-themes/1535
loop16        7:16   0   497M  1 loop /snap/gnome-42-2204/141
loop17        7:17   0 346,3M  1 loop /snap/gnome-3-38-2004/119
loop18        7:18   0  55,7M  1 loop /snap/core18/2829
sdb           8:16   0   350M  0 disk 
nvme0n1     259:0    0   477G  0 disk 
├─nvme0n1p1 259:1    0   3,8G  0 part /boot
├─nvme0n1p2 259:2    0   3,8G  0 part /boot/efi
├─nvme0n1p3 259:3    0   3,8G  0 part [SWAP]
└─nvme0n1p4 259:4    0 465,5G  0 part /

sudo mount /dev/sdb /media/test_USB3F

df -h
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
loop0         7:0    0     4K  1 loop /snap/bare/5
loop1         7:1    0    64M  1 loop /snap/core20/2318
loop2         7:2    0  63,9M  1 loop /snap/core20/2182
loop3         7:3    0   292K  1 loop /snap/device-tree-compiler/91
loop4         7:4    0 505,1M  1 loop /snap/gnome-42-2204/176
loop5         7:5    0  74,2M  1 loop /snap/core22/1439
loop6         7:6    0  11,9M  1 loop /snap/nmap/3470
loop7         7:7    0 349,7M  1 loop /snap/gnome-3-38-2004/143
loop8         7:8    0  74,2M  1 loop /snap/core22/1380
loop9         7:9    0  12,9M  1 loop /snap/snap-store/1113
loop10        7:10   0  38,8M  1 loop /snap/snapd/21759
loop11        7:11   0  40,9M  1 loop /snap/snapd/20290
loop12        7:12   0  11,9M  1 loop /snap/nmap/3514
loop13        7:13   0  12,3M  1 loop /snap/snap-store/959
loop14        7:14   0   9,7M  1 loop /snap/htop/4407
loop15        7:15   0  91,7M  1 loop /snap/gtk-common-themes/1535
loop16        7:16   0   497M  1 loop /snap/gnome-42-2204/141
loop17        7:17   0 346,3M  1 loop /snap/gnome-3-38-2004/119
loop18        7:18   0  55,7M  1 loop /snap/core18/2829
sdb           8:16   0   350M  0 disk /media/test_USB3F
nvme0n1     259:0    0   477G  0 disk 
├─nvme0n1p1 259:1    0   3,8G  0 part /boot
├─nvme0n1p2 259:2    0   3,8G  0 part /boot/efi
├─nvme0n1p3 259:3    0   3,8G  0 part [SWAP]
└─nvme0n1p4 259:4    0 465,5G  0 part /

dd if=/dev/urandom of=./file-10M bs=1M count=10
10+0 records in
10+0 records out
10485760 bytes (10 MB, 10 MiB) copied, 0,0834377 s, 126 MB/s

sudo cp ./file-10M /media/test_USB3F

md5sum ./file-10M /media/test_USB3F/file-10M
b6b6e3d0f4f5e493e5b728557e9a61c7  ./file-10M
b6b6e3d0f4f5e493e5b728557e9a61c7  /media/test_USB3F/file-10M

sudo umount /media/test_USB3F

----------- BOARD ------------

root@salvator-x:~# rmmod g_mass_storage
root@salvator-x:~# 
root@salvator-x:~# rm -rf /tmp/tmp.img
root@salvator-x:~# 

---------- HOST-PC -----------

dmesg
[79236.538767] EXT4-fs error (device sdc): __ext4_find_entry:1682: inode #2: comm gvfsd-trash: reading directory lblock 0
[79236.539518] EXT4-fs error (device sdc): __ext4_find_entry:1682: inode #2: comm gvfsd-trash: reading directory lblock 0
[79236.905141] usb 2-1.4: USB disconnect, device number 103
[79237.092228] sd 1:0:0:0: [sdb] Synchronizing SCSI cache
[79237.092268] sd 1:0:0:0: [sdb] Synchronize Cache(10) failed: Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK
BOARD
echo scan  > /sys/kernel/debug/kmemleak

root@salvator-x:~# echo scan > /sys/kernel/debug/kmemleak
root@salvator-x:~# 
root@salvator-x:~# cat /sys/kernel/debug/kmemleak
root@salvator-x:~# 
 
#### Result: OK ####
