----------- CASE 4 ------------
----------- BOARD ------------

root@salvator-x:~# mount -t tmpfs -o size=400M tmpfs /tmp
root@salvator-x:~# 
root@salvator-x:~# dd if=/dev/zero of=/tmp/tmp.img bs=1M count=350
350+0 records in
350+0 records out
367001600 bytes (367 MB, 350 MiB) copied, 1.68667 s, 218 MB/s
root@salvator-x:~# 
root@salvator-x:~# mkfs.ext3 -L storage /tmp/tmp.img
mke2fs 1.47.0 (5-Feb-2023)
Discarding device blocks:      0/358400             done                            
Creating filesystem with 358400 1k blocks and 89760 inodes
Filesystem UUID: 78bc7f2a-5dcc-4aaa-a5b5-3b6acb4f263d
Superblock backups stored on blocks: 
	8193, 24577, 40961, 57345, 73729, 204801, 221185

Allocating group tables:  0/44     done                            
Writing inode tables:  0/44     done                            
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information:  0/44     done

root@salvator-x:~# 
root@salvator-x:~# modprobe g_multi file=/tmp/tmp.img
root@salvator-x:~# 
root@salvator-x:~# rmmod g_multi
root@salvator-x:~# 
root@salvator-x:~# modprobe g_multi file=/tmp/tmp.img
[  195.621247] using random self ethernet address
[  195.626603] using random host ethernet address
[  195.632007] Mass Storage Function, version: 2009/09/11
[  195.637341] LUN: removable file: (no medium)
[  195.642056] LUN: file: /tmp/tmp.img
[  195.645641] Number of LUNs=1
[  195.651538] usb0: HOST MAC 1e:d6:0f:01:72:eb
[  195.655911] usb0: MAC a2:28:87:59:3c:91
[  195.660619] g_multi gadget: Multifunction Composite Gadget
[  195.666240] g_multi gadget: userspace failed to provide iSerialNumber
[  195.672783] g_multi gadget: g_multi ready
root@salvator-x:~# 
root@salvator-x:~# cat /sys/devices/platform/soc/e659c000.usb/udc/e659c000.usb/s 
tate
configured
root@salvator-x:~# 

---------- HOST-PC -----------


sudo ifconfig usb0 192.168.11.2 up

----------- BOARD ------------

root@salvator-x:~# ifconfig usb0 192.168.11.1 up
root@salvator-x:~# 
root@salvator-x:~# ping -c 4 192.168.11.2 -s 128
PING 192.168.11.2 (192.168.11.2): 128 data bytes
136 bytes from 192.168.11.2: seq=0 ttl=64 time=2.002 ms
136 bytes from 192.168.11.2: seq=1 ttl=64 time=1.589 ms
136 bytes from 192.168.11.2: seq=2 ttl=64 time=0.913 ms
136 bytes from 192.168.11.2: seq=3 ttl=64 time=0.662 ms

--- 192.168.11.2 ping statistics ---
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max = 0.662/1.291/2.002 ms
root@salvator-x:~# 
root@salvator-x:~# cat /proc/interrupts | grep -e e647 > before_usb_dmac11_int.t 
xt
root@salvator-x:~# 
---------- HOST-PC -----------

dmesg
[89067.374158] usb 1-1.3: USB disconnect, device number 84
[89067.374323] rndis_host 1-1.3:1.0 usb0: unregister 'rndis_host' usb-0000:00:14.0-1.3, RNDIS device
[89067.412690] print_req_error: 7 callbacks suppressed
[89067.412694] blk_update_request: I/O error, dev sdc, sector 0 op 0x1:(WRITE) flags 0x800 phys_seg 0 prio class 0
[89067.439881] buffer_io_error: 122 callbacks suppressed
[89067.439885] Buffer I/O error on dev sdc, logical block 786, lost sync page write
[89067.439892] JBD2: Error -5 detected when updating journal superblock for sdc-8.
[89067.439895] Aborting journal on device sdc-8.
[89067.439898] Buffer I/O error on dev sdc, logical block 786, lost sync page write
[89067.439901] JBD2: Error -5 detected when updating journal superblock for sdc-8.
[89067.439918] EXT4-fs error (device sdc): ext4_put_super:1204: comm umount: Couldn't clean up the journal
[89067.439923] EXT4-fs (sdc): Remounting filesystem read-only
[89067.455855] sd 2:0:0:0: [sdc] Synchronizing SCSI cache
[89067.455978] sd 2:0:0:0: [sdc] Synchronize Cache(10) failed: Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK
[89068.619264] usb 1-1.3: new high-speed USB device number 85 using xhci_hcd
[89068.722559] usb 1-1.3: New USB device found, idVendor=1d6b, idProduct=0104, bcdDevice= 5.10
[89068.722579] usb 1-1.3: New USB device strings: Mfr=3, Product=4, SerialNumber=0
[89068.722589] usb 1-1.3: Product: Multifunction Composite Gadget
[89068.722596] usb 1-1.3: Manufacturer: Linux 5.10.218-yocto-standard with renesas_usbhs_udc
[89068.731716] rndis_host 1-1.3:1.0 usb0: register 'rndis_host' at usb-0000:00:14.0-1.3, RNDIS device, 4a:48:a8:1a:c1:84
[89068.733347] cdc_acm 1-1.3:1.2: ttyACM0: USB ACM device
[89068.734155] usb-storage 1-1.3:1.4: USB Mass Storage device detected
[89068.734722] scsi host2: usb-storage 1-1.3:1.4
[89069.756558] scsi 2:0:0:0: Direct-Access     Linux    File-Stor Gadget 0510 PQ: 0 ANSI: 2
[89069.757024] sd 2:0:0:0: Attached scsi generic sg1 type 0
[89069.757573] sd 2:0:0:0: Power-on or device reset occurred
[89069.758356] sd 2:0:0:0: [sdc] 716800 512-byte logical blocks: (367 MB/350 MiB)
[89069.865623] sd 2:0:0:0: [sdc] Write Protect is off
[89069.865637] sd 2:0:0:0: [sdc] Mode Sense: 0f 00 00 00
[89069.973488] sd 2:0:0:0: [sdc] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA
[89070.302133] sd 2:0:0:0: [sdc] Attached SCSI disk
[89070.756459] EXT4-fs (sdc): mounting ext3 file system using the ext4 subsystem
[89070.776208] EXT4-fs (sdc): mounted filesystem with ordered data mode. Opts: (null). Quota mode: none.

df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            3,8G     0  3,8G   0% /dev
tmpfs           784M  2,4M  781M   1% /run
/dev/nvme0n1p4  458G  302G  133G  70% /
tmpfs           3,9G     0  3,9G   0% /dev/shm
tmpfs           5,0M   12K  5,0M   1% /run/lock
tmpfs           3,9G     0  3,9G   0% /sys/fs/cgroup
/dev/loop0      128K  128K     0 100% /snap/bare/5
/dev/loop3       64M   64M     0 100% /snap/core20/2182
/dev/loop1       56M   56M     0 100% /snap/core18/2829
/dev/loop2       64M   64M     0 100% /snap/core20/2318
/dev/loop4       75M   75M     0 100% /snap/core22/1439
/dev/loop5       75M   75M     0 100% /snap/core22/1380
/dev/loop8      506M  506M     0 100% /snap/gnome-42-2204/176
/dev/loop12      12M   12M     0 100% /snap/nmap/3470
/dev/loop10      92M   92M     0 100% /snap/gtk-common-themes/1535
/dev/loop11     350M  350M     0 100% /snap/gnome-3-38-2004/143
/dev/loop7      497M  497M     0 100% /snap/gnome-42-2204/141
/dev/loop6      384K  384K     0 100% /snap/device-tree-compiler/91
/dev/loop9      9,8M  9,8M     0 100% /snap/htop/4407
/dev/loop14      41M   41M     0 100% /snap/snapd/20290
/dev/loop17      13M   13M     0 100% /snap/snap-store/1113
/dev/loop13     347M  347M     0 100% /snap/gnome-3-38-2004/119
/dev/loop15      13M   13M     0 100% /snap/snap-store/959
/dev/loop16      12M   12M     0 100% /snap/nmap/3514
/dev/loop18      39M   39M     0 100% /snap/snapd/21759
/dev/nvme0n1p1  3,7G  210M  3,3G   6% /boot
/dev/nvme0n1p2  3,9G  6,1M  3,9G   1% /boot/efi
tmpfs           784M   28K  784M   1% /run/user/1000
/dev/sdb        968M  601M  317M  66% /home/rvc/mnt/usb
/dev/sdc        318M   47K  301M   1% /media/rvc/storage

sudo time dd if=/dev/urandom of=/media/rvc/storage/file-10M bs=10M count=1 oflag=direct
1+0 records in
1+0 records out
10485760 bytes (10 MB, 10 MiB) copied, 0,0551011 s, 190 MB/s
0.00user 0.05system 0:00.05elapsed 98%CPU (0avgtext+0avgdata 12640maxresident)k
2inputs+20480outputs (0major+2651minor)pagefaults 0swaps

sudo time dd if=/media/rvc/storage/file-10M of=./file-10M_from_board bs=10M iflag=direct
1+0 records in
1+0 records out
10485760 bytes (10 MB, 10 MiB) copied, 1,37246 s, 7,6 MB/s
0.00user 0.04system 0:01.37elapsed 3%CPU (0avgtext+0avgdata 12796maxresident)k
20480inputs+20480outputs (0major+2655minor)pagefaults 0swaps


---------- BOARD -----------


root@salvator-x:~# ping -c 4 192.168.11.2 -s 128
PING 192.168.11.2 (192.168.11.2): 128 data bytes
136 bytes from 192.168.11.2: seq=0 ttl=64 time=0.828 ms
136 bytes from 192.168.11.2: seq=1 ttl=64 time=0.759 ms
136 bytes from 192.168.11.2: seq=2 ttl=64 time=0.994 ms
136 bytes from 192.168.11.2: seq=3 ttl=64 time=0.423 ms

--- 192.168.11.2 ping statistics ---
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max = 0.423/0.751/0.994 ms
root@salvator-x:~# 
root@salvator-x:~# cat /proc/interrupts | grep -e e647 > after_usb_dmac11_int.tx 
t
root@salvator-x:~# 
root@salvator-x:~# cat before_usb_dmac11_int.txt
 48:        782          0          0          0          0          0          0          0     GIC-0  67 Level     e6470000.dma-controller:0, e6470000.dma-controller:1
root@salvator-x:~# 
root@salvator-x:~# cat after_usb_dmac11_int.txt
 48:       2317          0          0          0          0          0          0          0     GIC-0  67 Level     e6470000.dma-controller:0, e6470000.dma-controller:1
root@salvator-x:~# cmp /media/rvc/storage/file-10M ./file-10M_from_board

sudo umount /media/rvc/storage

----------- BOARD ------------

root@salvator-x:~# rmmod g_multi
root@salvator-x:~# 
root@salvator-x:~# rm -rf /tmp/tmp.img
root@salvator-x:~# 

---------- HOST-PC -----------

dmesg
[89086.062270] usb 1-1.3: USB disconnect, device number 85
[89086.062508] rndis_host 1-1.3:1.0 usb0: unregister 'rndis_host' usb-0000:00:14.0-1.3, RNDIS device
[89086.129648] sd 2:0:0:0: [sdc] Synchronizing SCSI cache
[89086.129702] sd 2:0:0:0: [sdc] Synchronize Cache(10) failed: Result: hostbyte=DID_NO_CONNECT driverbyte=DRIVER_OK

 
#### Result: OK ####
